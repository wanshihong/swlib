## 18. 工具类

SWLib 框架提供了一套丰富的工具类，位于 `Swlib\Utils` 命名空间下，涵盖日志、文件操作、字符串转换、HTTP 请求、加密等常用功能。

### 18.1 工具类概览

| 类 | 功能 | 核心方法 |
|----|------|---------|
| `Log` | 日志记录 | `info()`, `error()`, `debug()`, `warning()`, `saveException()` |
| `File` | 文件和目录操作 | `save()`, `eachDir()`, `copyDirectory()`, `delDirectory()` |
| `StringConverter` | 字符串命名转换 | `underscoreToCamelCase()`, `camelCaseToUnderscore()` |
| `DataConverter` | 数据格式转换 | `convertToArray()`, `exportShort()` |
| `Url` | URL 生成和处理 | `generateUrl()`, `appendQueryParams()`, `isAdmin()` |
| `Http` | HTTP 请求 | `get()`, `post()`, `responseArray()`, `responseOriginal()` |
| `Ip` | IP 地址处理 | `get()`, `isLocal()` |
| `Crypto` | 加密签名 | `hmacSha256()`, `sign()` |
| `Cookie` | Cookie 操作 | `set()`, `get()`, `delete()`, `has()` |
| `Twig` | 模板引擎 | `getInstance()` |
| `TypeHelper` | 类型助手 | `getDefaultValueForProperty()`, `isPropertyNullable()` |
| `FileCache` | 文件缓存 | `get()`, `set()`, `delete()`, `clearExpire()` |
| `DevSslCert` | 开发环境 SSL 证书 | `ensureCertificate()`, `generateAndGetConfig()` |

---

### 18.2 Log 日志工具

`Log` 类提供多级别的日志记录功能，日志按日期存储在 `runtime/log/{日期}/` 目录下。

#### 日志级别

```php
use Swlib\Utils\Log;

// 调试级别 - 仅在开发环境记录
Log::debug('调试信息', ['user_id' => 123], 'user');

// 信息级别 - 记录一般信息
Log::info('用户登录', ['user_id' => 123, 'ip' => '192.168.1.1'], 'auth');

// 警告级别 - 记录警告信息
Log::warning('库存不足', ['product_id' => 456, 'stock' => 5], 'inventory');

// 错误级别 - 记录错误信息
Log::error('支付失败', ['order_id' => 789, 'error' => 'timeout'], 'payment');
```

#### 基本日志记录

```php
use Swlib\Utils\Log;

// 简单日志
Log::save('这是一条日志消息', 'custom');

// 支持数组和字符串
Log::write(['key' => 'value', 'data' => [1, 2, 3]], 'module_name');

// 仅在非生产环境记录
Log::debugOnly('调试信息，生产环境不会记录', ['context' => 'data']);
```

#### 异常日志

```php
use Swlib\Utils\Log;

try {
    // 业务代码
    throw new Exception('测试异常');
} catch (Exception $e) {
    // 记录异常完整堆栈
    Log::saveException($e, 'error');

    // 或获取格式化的异常信息
    $traceMsg = Log::getTraceMsg($e);
    Log::save($traceMsg, 'exception');
}
```

#### 批量日志

```php
use Swlib\Utils\Log;

Log::batch([
    ['message' => '日志1', 'context' => [], 'module' => 'module1', 'level' => 'info'],
    ['message' => '日志2', 'context' => ['key' => 'value'], 'module' => 'module2', 'level' => 'error'],
    ['message' => '日志3', 'module' => 'module3'], // 默认 info 级别
]);
```

#### 日志文件位置

```
runtime/
└── log/
    └── 20240115/
        ├── info.log        # Log::info() 产生
        ├── error.log       # Log::error() 产生
        ├── debug.log       # Log::debug() 产生
        ├── warning.log     # Log::warning() 产生
        └── custom.log      # Log::save($msg, 'custom') 产生
```

日志格式示例：
```
[14:30:25] [request_id_123] [/api/user/info] [INFO] 用户登录 {"user_id":123}
```

---

### 18.3 File 文件操作工具

`File` 类提供文件和目录的常用操作方法。

#### 保存文件

```php
use Swlib\Utils\File;

// 保存内容到文件（自动创建目录）
File::save('/path/to/file.txt', '文件内容');

// 追加内容
File::save('/path/to/file.txt', "\n追加内容", true);

// 保存数组为 JSON
File::save('/path/to/data.json', json_encode(['key' => 'value']));
```

#### 目录遍历

```php
use Swlib\Utils\File;

// 遍历目录下所有文件
$files = File::eachDir('/path/to/directory');

// 带过滤条件（只获取 .php 文件）
$phpFiles = File::eachDir('/path/to/directory', function ($filePath) {
    return str_ends_with($filePath, '.php');
});

// 带过滤条件（排除特定目录）
$files = File::eachDir('/path/to/directory', function ($filePath) {
    return !str_contains($filePath, '/vendor/');
});
```

#### 目录复制

```php
use Swlib\Utils\File;

// 递归复制整个目录
File::copyDirectory('/source/dir', '/target/dir');
```

#### 目录删除

```php
use Swlib\Utils\File;

// 递归删除目录及其内容
File::delDirectory('/path/to/directory');

// 确保目录存在
File::ensureDirectoryExists('/path/to/new/directory');
```

---

### 18.4 StringConverter 字符串转换工具

`StringConverter` 类提供驼峰命名和下划线命名之间的转换功能。

#### 下划线转驼峰

```php
use Swlib\Utils\StringConverter;

// 小驼峰（默认）
$camelCase = StringConverter::underscoreToCamelCase('user_id', '_', false);
// 结果：'userId'

// 大驼峰
$pascalCase = StringConverter::underscoreToCamelCase('user_name', '_', true);
// 结果：'UserName'

// 处理中划线
$camelCase = StringConverter::underscoreToCamelCase('user-profile', '-', false);
// 结果：'userProfile'
```

#### 驼峰转下划线

```php
use Swlib\Utils\StringConverter;

$underscore = StringConverter::camelCaseToUnderscore('userId');
// 结果：'user_id'

$underscore = StringConverter::camelCaseToUnderscore('XMLHttpRequest');
// 结果：'xml_http_request'

// 使用中划线
$dash = StringConverter::camelCaseToUnderscore('userName', '-');
// 结果：'user-name'
```

#### 数组键名批量转换

```php
use Swlib\Utils\StringConverter;

// 数据库返回的下划线键名转换为驼峰
$dbData = [
    'user_id' => 1,
    'user_name' => 'John',
    'created_at' => '2024-01-01',
];

$camelCaseData = StringConverter::convertArrayKeysToCamelCase($dbData);
// 结果：
// [
//     'userId' => 1,
//     'userName' => 'John',
//     'createdAt' => '2024-01-01',
// ]

// 递归转换多维数组
$nested = [
    'user_info' => [
        'first_name' => 'John',
        'last_name' => 'Doe',
    ],
];
$result = StringConverter::convertArrayKeysToCamelCase($nested, true);
```

#### 获取前缀

```php
use Swlib\Utils\StringConverter;

$prefix = StringConverter::getPrefixBeforeUnderscore('user_id');
// 结果：'user'

$prefix = StringConverter::getPrefixBeforeUnderscore('simple');
// 结果：'simple'
```

---

### 18.5 DataConverter 数据转换工具

`DataConverter` 类提供数据格式转换功能。

#### 转换为数组

```php
use Swlib\Utils\DataConverter;

// JSON 字符串转数组
$arr = DataConverter::convertToArray('[1,2,3]');
// 结果：[1, 2, 3]

// 逗号分隔字符串转数组
$arr = DataConverter::convertToArray('1,2,3');
// 结果：['1', '2', '3']

// 已是数组直接返回
$arr = DataConverter::convertToArray([1, 2, 3]);
// 结果：[1, 2, 3]

// 数字转为单元素数组
$arr = DataConverter::convertToArray(123);
// 结果：[123]

// null 或空字符串返回空数组
$arr = DataConverter::convertToArray(null);
// 结果：[]
```

#### PHP 值导出（短语法）

```php
use Swlib\Utils\DataConverter;

// 基本类型
echo DataConverter::exportShort(null);      // 'null'
echo DataConverter::exportShort(true);      // 'true'
echo DataConverter::exportShort(false);     // 'false'
echo DataConverter::exportShort(123);       // '123'
echo DataConverter::exportShort('hello');   // "'hello'"

// 数组（使用 [] 语法）
echo DataConverter::exportShort([1, 2, 3]);
// 结果：
// [
//     0,
//     1,
//     2,
// ]

// 关联数组
echo DataConverter::exportShort(['name' => 'John', 'age' => 25]);
// 结果：
// [
//     'name' => 'John',
//     'age' => 25,
// ]
```

---

### 18.6 Url URL 生成工具

`Url` 类用于生成和处理 URL，支持传统的 Query 模式和 PathInfo 模式。

#### 生成 URL

```php
use Swlib\Utils\Url;

// 生成基于当前控制器的 URL（默认 PathInfo 模式）
$url = Url::generateUrl('user-detail', ['id' => 123]);
// 结果：'/module/user-detail/id/123'

// Query 模式
$url = Url::generateUrl('user-list', ['page' => 1], [], true, 'query');
// 结果：'/module/user-list?page=1'

// 绝对路径直接返回
$url = Url::generateUrl('/absolute/path', ['id' => 1]);
// 结果：'/absolute/path/id/1'

// 外部 URL 只追加 query 参数
$url = Url::generateUrl('https://example.com/api', ['key' => 'value']);
// 结果：'https://example.com/api?key=value'
```

#### 参数合并和删除

```php
use Swlib\Utils\Url;

// 合并当前请求参数
$url = Url::generateUrl('action', ['new_param' => 'value']);

// 不合并当前请求参数
$url = Url::generateUrl('action', ['id' => 1], [], false);

// 删除指定参数
$url = Url::generateUrl('action', ['page' => 2], ['sort', 'order']);
```

#### 追加 Query 参数

```php
use Swlib\Utils\Url;

$url = Url::appendQueryParams('/api/users', ['page' => 1, 'size' => 10]);
// 结果：'/api/users?page=1&size=10'

// URL 已有参数时使用 & 连接
$url = Url::appendQueryParams('/api/users?status=1', ['page' => 1]);
// 结果：'/api/users?status=1&page=1'
```

#### 检查后台路由

```php
use Swlib\Utils\Url;

if (Url::isAdmin($uri)) {
    // 这是后台管理路由
}
```

---

### 18.7 Http HTTP 请求工具

`Http` 类封装了 cURL，提供简洁的 HTTP 请求接口。

#### GET 请求

```php
use Swlib\Utils\Http;

// GET 请求
$http = new Http();
$http->setTimeout(30);

$response = $http->get('https://api.example.com/users', [
    'page' => 1,
    'size' => 10
])->responseArray();

// 获取原始响应
$raw = $http->get('https://api.example.com/data')->responseOriginal();
```

#### POST 请求

```php
use Swlib\Utils\Http;

$http = new Http();

// POST 表单数据
$response = $http->post('https://api.example.com/users', [
    'name' => 'John',
    'email' => 'john@example.com'
])->responseArray();

// POST JSON 数据
$http->setCustomHeaders(['Content-Type:application/json']);
$response = $http->post('https://api.example.com/users', json_encode([
    'name' => 'John',
    'email' => 'john@example.com'
]))->responseArray();
```

#### 自定义请求头

```php
use Swlib\Utils\Http;

$http = new Http();

// 设置自定义头部（注意格式）
$http->setCustomHeaders([
    'Content-Type:application/json',
    'Authorization:Bearer token123',
    'X-API-Key:abc123'
]);

$response = $http->get('https://api.example.com/protected')->responseArray();
```

#### 设置超时

```php
use Swlib\Utils\Http;

$http = new Http();
$http->setTimeout(60); // 60秒超时

$response = $http->get('https://api.example.com/slow')->responseArray();
```

---

### 18.8 IP 地址工具

`Ip` 类用于获取客户端 IP 和判断 IP 类型。

#### 获取客户端 IP

```php
use Swlib\Utils\Ip;

$ip = Ip::get();
// 返回客户端真实 IP，支持代理场景
// 优先级：X-Real-IP > X-Forwarded-For > Remote-Addr
```

#### 判断本地 IP

```php
use Swlib\Utils\Ip;

// 检查是否为本地/私有 IP
if (Ip::isLocal('192.168.1.1')) {
    // 是本地 IP
}

if (Ip::isLocal('127.0.0.1')) {
    // 是回环地址
}

if (Ip::isLocal('10.0.0.1')) {
    // 是私有地址
}

if (Ip::isLocal('::1')) {
    // 是 IPv6 回环地址
}
```

---

### 18.9 Crypto 加密工具

`Crypto` 类提供 HMAC-SHA256 签名功能，用于 API 签名验证。

#### HMAC-SHA256 签名

```php
use Swlib\Utils\Crypto;

// 计算 HMAC-SHA256
$signature = Crypto::hmacSha256('message', 'secret_key');
// 返回十六进制格式的签名
```

#### API 签名生成

```php
use Swlib\Utils\Crypto;

// 生成 API 签名
$url = '/api/v1/users';
$random = bin2hex(random_bytes(16));
$timestamp = (string)time();
$appSecret = 'your_app_secret';

$signature = Crypto::sign($url, $random, $timestamp, $appSecret);

// 发送请求时携带签名
// Headers:
//   X-Signature: $signature
//   X-Nonce: $random
//   X-Timestamp: $timestamp
```

#### 签名验证示例

```php
// 服务端验证签名
$receivedSignature = $request->header['x-signature'];
$nonce = $request->header['x-nonce'];
$timestamp = $request->header['x-timestamp'];

$expectedSignature = Crypto::sign($uri, $nonce, $timestamp, $appSecret);

if (!hash_equals($expectedSignature, $receivedSignature)) {
    throw new AppException('签名验证失败');
}
```

---

### 18.10 Cookie 操作工具

`Cookie` 类封装了 Cookie 的读写操作，支持 Swoole 环境。

#### 设置 Cookie

```php
use Swlib\Utils\Cookie;

// 基本设置
Cookie::set('session_id', 'abc123', 3600); // 1小时过期

// 完整参数
Cookie::set(
    key: 'user_token',
    value: 'xyz789',
    expire: 86400,      // 过期时间（秒）
    path: '/',          // 路径
    domain: '.example.com', // 域名
    secure: true,       // 仅 HTTPS
    httpOnly: true,     // 仅 HTTP 访问
    sameSite: 'Strict'  // SameSite 属性
);
```

#### 获取 Cookie

```php
use Swlib\Utils\Cookie;

// 获取 Cookie 值
$sessionId = Cookie::get('session_id');

// 带默认值
$theme = Cookie::get('theme', 'light');

// 检查 Cookie 是否存在
if (Cookie::has('user_token')) {
    // Cookie 存在
}
```

#### 删除 Cookie

```php
use Swlib\Utils\Cookie;

// 删除 Cookie
Cookie::delete('session_id');

// 删除指定路径和域名的 Cookie
Cookie::delete('user_token', '/', '.example.com');
```

#### 项目隔离

```php
use Swlib\Utils\Cookie;

// Cookie 名称会自动添加项目唯一标识前缀
$actualKey = Cookie::getKey('session');
// 结果：'session:project_unique_id'

// 这样不同项目可以使用相同的 Cookie 名称而不会冲突
```

---

### 18.11 Twig 模板引擎

`Twig` 类是对 Twig 模板引擎的封装，用于后台管理系统的视图渲染。

#### 获取实例

```php
use Swlib\Utils\Twig;

$twig = Twig::getInstance();
$twigEnv = $twig->twig; // 获取 Twig\Environment 实例
```

#### 渲染模板

```php
use Swlib\Utils\Twig;

$twig = Twig::getInstance();
$html = $twig->twig->render('user/list.html', [
    'users' => $users,
    'page' => $page,
]);
```

#### 模板目录

模板目录优先级：
1. `ROOT_DIR/templates/` - 项目自定义模板
2. `SWLIB_DIR/Admin/Templates/` - 框架默认模板
3. `SWLIB_DIR/DevTool/Templates/` - 开发工具模板（仅非生产环境）

#### 内置函数

Twig 模板中可使用以下内置函数：

```twig
{# 生成 URL #}
<a href="{{ url('user-detail', {'id': user.id}) }}">查看详情</a>

{# 获取翻译 #}
<span>{{ lang('user.login') }}</span>

{# 获取字段别名 #}
<option value="{{ field }}">{{ getFieldAsByName(tableName, field) }}</option>

{# 获取当前操作名称 #}
{% if getCurrentAction() == 'edit' %}
    {# 编辑页面 #}
{% endif %}

{# 获取后台布局管理器 #}
{% set layout = adminLayout() %}

{# 获取当前登录管理员 #}
{% set adminUser = adminUser() %}
```

---

### 18.12 TypeHelper 类型助手

`TypeHelper` 类提供与 PHP 类型相关的实用方法。

#### 获取属性默认值

```php
use Swlib\Utils\TypeHelper;

class User {
    public string $name;
    public ?int $age;
    public array $tags = [];
    public bool $active;
}

$user = new User();

// 根据属性类型获取默认值
$defaultName = TypeHelper::getDefaultValueForProperty($user, 'name');   // ''
$defaultAge = TypeHelper::getDefaultValueForProperty($user, 'age');     // null
$defaultTags = TypeHelper::getDefaultValueForProperty($user, 'tags');   // []
$defaultActive = TypeHelper::getDefaultValueForProperty($user, 'active'); // false
```

#### 检查属性是否可为空

```php
use Swlib\Utils\TypeHelper;

class Example {
    public string $required;      // 不可为空
    public ?string $optional;     // 可为空
    public string|null $union;    // 联合类型，可为空
}

$obj = new Example();

TypeHelper::isPropertyNullable($obj, 'required');  // false
TypeHelper::isPropertyNullable($obj, 'optional');  // true
TypeHelper::isPropertyNullable($obj, 'union');     // true
```

#### 获取属性类型名称

```php
use Swlib\Utils\TypeHelper;

class User {
    public string $name;
    public ?int $age;
}

$user = new User();

TypeHelper::getPropertyTypeName($user, 'name'); // 'string'
TypeHelper::getPropertyTypeName($user, 'age');  // 'int' (返回第一个非 null 类型)
```

#### 安全设置属性值

```php
use Swlib\Utils\TypeHelper;

class User {
    public string $name;
    public int $age;
}

$user = new User();

// 如果值为 null 且属性不允许为空，自动设置默认值
TypeHelper::safeSetProperty($user, 'name', null);  // $user->name = ''
TypeHelper::safeSetProperty($user, 'age', null);   // $user->age = 0

// 正常设置值
TypeHelper::safeSetProperty($user, 'name', 'John'); // $user->name = 'John'
```

#### 类型默认值映射

```php
use Swlib\Utils\TypeHelper;

TypeHelper::getDefaultValueByTypeName('string');   // ''
TypeHelper::getDefaultValueByTypeName('int');      // 0
TypeHelper::getDefaultValueByTypeName('float');    // 0.0
TypeHelper::getDefaultValueByTypeName('bool');     // false
TypeHelper::getDefaultValueByTypeName('array');    // []
TypeHelper::getDefaultValueByTypeName('object');   // null
```

---

### 18.13 FileCache 文件缓存

`FileCache` 类提供基于文件的缓存功能，支持多级目录存储。

#### 基本操作

```php
use Swlib\Utils\FileCache;

// 设置缓存（默认 24 小时过期）
FileCache::set('cache_key', ['data' => 'value']);

// 设置缓存并指定过期时间（秒）
FileCache::set('user_profile_123', $profile, 3600); // 1小时

// 获取缓存
$data = FileCache::get('cache_key');
if ($data !== null) {
    // 缓存命中
} else {
    // 缓存不存在或已过期
}

// 删除缓存
FileCache::delete('cache_key');
```

#### 缓存穿透保护

```php
use Swlib\Utils\FileCache;

// 使用缓存穿透保护模式
$user = FileCache::get("user_{$id}");
if ($user === null) {
    $user = new UserTable()->where([UserTable::ID => $id])->selectOne();
    if ($user !== null) {
        FileCache::set("user_{$id}", $user, 300);
    }
}
```

#### 清理过期缓存

```php
use Swlib\Utils\FileCache;

// 清理所有过期缓存
FileCache::clearExpire();

// 清理指定时间之前修改的文件
FileCache::clearExpire(strtotime('-7 days'));
```

#### 缓存存储结构

缓存文件存储在 `runtime/cache/distributed_file_cache/` 目录下，使用多级目录结构：

```
runtime/cache/distributed_file_cache/
├── ab/
│   └── cd/
│       └── ef/
│           └── gh/
│               └── ij/
│                   └── kl/
│                       └── mn/
│                           └── op/
│                               └── qr/
│                                   └── stuvwxyz123456.cache
```

---

### 18.14 DevSslCert 开发环境 SSL 证书

`DevSslCert` 类用于管理开发环境的自签名 SSL 证书。

#### 获取证书配置

```php
use Swlib\Utils\DevSslCert;

// 生成或获取现有证书，返回 Swoole SSL 配置
$config = DevSslCert::generateAndGetConfig($swooleConfig);
```

#### 证书文件位置

证书存放在用户目录下，多个项目共用：

```php
use Swlib\Utils\DevSslCert;

$sslDir = DevSslCert::getSslDir();    // ~/.swlib-ssl/
$certFile = DevSslCert::getCertFile(); // ~/.swlib-ssl/cert.pem
$keyFile = DevSslCert::getKeyFile();   // ~/.swlib-ssl/key.pem
$iosCert = DevSslCert::getIosCertFile(); // ~/.swlib-ssl/cert_ios.cer
```

#### 自动证书管理

```php
use Swlib\Utils\DevSslCert;

// 确保证书存在且有效
// 如果证书不存在或 IP 变化，会自动重新生成
DevSslCert::ensureCertificate();
```

#### iOS 证书

生成的 iOS 证书（DER 格式）可以安装在 iOS 设备上，用于 HTTPS 调试：

1. 访问 `https://your-server-ip/cert_ios.cer`
2. 下载并安装证书
3. 在 设置 > 通用 > 关于本机 > 证书信任设置 中启用信任

---

### 18.15 使用建议

#### 日志规范

```php
// 推荐：使用语义化的日志级别和模块名
Log::info('订单创建成功', [
    'order_id' => $orderId,
    'user_id' => $userId,
    'amount' => $amount
], 'order');

// 推荐：异常日志使用 saveException
try {
    // ...
} catch (Exception $e) {
    Log::saveException($e, 'payment');
    throw $e;
}

// 不推荐：硬编码消息
Log::save("用户 $userId 登录失败"); // 难以搜索和分析
```

#### HTTP 请求规范

```php
// 推荐：设置合理的超时时间
$http = new Http();
$http->setTimeout(10);

// 推荐：处理异常
try {
    $response = $http->get($url)->responseArray();
} catch (AppException $e) {
    Log::error('API请求失败', ['url' => $url, 'error' => $e->getMessage()]);
    throw new AppException('服务暂时不可用');
}
```

#### 缓存使用规范

```php
// 推荐：使用有意义的缓存键名
FileCache::set("user:profile:{$userId}", $profile, 3600);

// 推荐：处理缓存穿透
$data = FileCache::get($key) ?? $this->fetchFromDatabase($id);

// 不推荐：缓存过大的数据
FileCache::set('large_list', $hugeArray); // 可能导致内存问题
```
