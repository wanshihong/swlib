## 11. 任务处理

Task 进程用于立即执行的后台异步任务，与队列系统不同，Task 不需要等待，投递后立即执行。

### 11.1 Task 注解

使用 `#[TaskAttribute]` 注解将方法标记为 Task 任务：

```php
use Swlib\TaskProcess\Attribute\TaskAttribute;

class ReportService
{
    #[TaskAttribute(
        name: '生成日报',      // 可选的任务名称
        timeout: 600          // 超时时间（秒），默认300秒
    )]
    public static function generateDailyReport(int $userId): void
    {
        // 业务逻辑在 Task 进程中执行
        $report = self::buildReport($userId);

        // 发送邮件
        Mail::to($user->email)->send($report);
    }
}

// 调用方式：正常调用方法即可，代理会自动投递到 Task 进程
ReportService::generateDailyReport($userId);
```

**关键特点：**
- 用户只需声明注解，**正常调用方法**即可完成投递
- 不需要主动调用 `TaskDispatcher::dispatch()`
- 方法在 Task 进程中**立即执行**（不是延迟）
- 方法返回值必须是 `void`（异步执行无返回值）

### 11.2 注解参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `name` | string | '' | 任务名称，默认使用 `类名_方法名` |
| `timeout` | int | 300 | 任务执行超时时间（秒） |
| `priority` | int | 0 | 执行优先级（多个注解时需显式指定） |
| `async` | bool | true | 是否异步执行 |

### 11.3 使用示例

#### 基本 Task 任务

```php
use Swlib\TaskProcess\Attribute\TaskAttribute;

class ImageService
{
    #[TaskAttribute]
    public static function processImage(int $imageId): void
    {
        $image = new ImageTable()->where([ImageTable::ID => $imageId])->selectOne();

        // 处理图片（压缩、裁剪等）
        self::compress($image);
        self::generateThumbnail($image);

        // 更新状态
        new ImageTable()->where([ImageTable::ID => $imageId])->update([
            ImageTable::STATUS => 'processed'
        ]);
    }
}

// 调用：正常调用即可
ImageService::processImage($imageId);
```

#### 带超时设置

```php
#[TaskAttribute(
    name: '导出大量数据',
    timeout: 1800  // 30分钟超时
)]
public static function exportLargeData(int $batchId): void
{
    // 导出逻辑可能需要较长时间
    // ...
}
```

### 11.4 参数限制

Task 使用 PHP 序列化传递数据，**不支持以下类型**：

| 不支持类型 | 说明 |
|-----------|------|
| 资源类型 | MySQL/Redis 连接、文件句柄 |
| 闭包 | 匿名函数 |
| 包含上述类型的对象 | 任何包含资源的对象 |

```php
// ❌ 错误：传递数据库连接
#[TaskAttribute]
public static function badExample(mysqli $conn): void
{
    // 错误！连接不能序列化
}

// ✅ 正确：传递ID
#[TaskAttribute]
public static function goodExample(int $userId): void
{
    // 在 Task 进程中重新获取连接
    $user = new UserTable()->where([UserTable::ID => $userId])->selectOne();
}
```

### 11.5 返回值

Task 方法**必须声明返回类型为 void**：

```php
// ✅ 正确
#[TaskAttribute]
public static function process(int $id): void
{
    // 处理逻辑
}

// ❌ 错误：Task 方法不能有返回值
#[TaskAttribute]
public static function process(int $id): int  // 错误！
{
    return 1;
}
```

### 11.6 事务支持

Task 任务支持与 `#[Transaction]` 注解配合使用：

```php
use Swlib\TaskProcess\Attribute\TaskAttribute;
use Swlib\Table\Attributes\Transaction;

class OrderService
{
    #[TaskAttribute]
    #[Transaction]
    public static function processOrder(int $orderId): void
    {
        // 这些操作会在事务中执行
        new OrderTable()->where([OrderTable::ID => $orderId])->update([
            OrderTable::STATUS => 'processing'
        ]);

        new OrderLogTable()->insert([
            OrderLogTable::ORDER_ID => $orderId,
            OrderLogTable::ACTION => 'process'
        ]);
    }
}
```

### 11.7 Task 与队列的对比

| 特性 | Task (`#[TaskAttribute]`) | 队列 (`#[QueueAttribute]`) |
|------|---------------------------|----------------------------|
| 执行时机 | **立即执行** | 可设置延迟执行 |
| 返回值 | 无 (void) | 返回队列ID |
| 重试机制 | 无 | 支持重试和重试间隔 |
| 进度跟踪 | 不支持 | 支持 `updateProgress` |
| 适用场景 | 简单异步任务 | 延迟任务、长时间任务 |

### 11.8 执行原理

```
┌─────────────────────────────────────────────────────────────┐
│ 调用方                                                         │
│ ReportService::generateDailyReport($userId);                │
└────────────────────────┬────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ 代理拦截 (TaskAttribute)                                      │
│ 1. 验证参数可序列化                                           │
│ 2. 投递到 Swoole Task 进程                                    │
│ 3. 立即返回 null                                              │
└────────────────────────┬────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ Task 进程 (OnTaskEvent)                                       │
│ 1. 接收任务数据                                              │
│ 2. 调用原方法执行                                            │
│ 3. 处理异常                                                  │
└─────────────────────────────────────────────────────────────┘
```

**特殊处理：** 如果已经在 Task 进程中调用 Task 方法，会**直接执行**，避免死锁。

### 11.9 最佳实践

1. **参数简单**：只传递 ID 等简单类型，避免传递复杂对象
2. **返回 void**：始终声明返回类型为 void
3. **独立事务**：需要在事务中执行时，添加 `#[Transaction]` 注解
4. **超时设置**：长时间运行的任务务必设置合理的 timeout
5. **异常处理**：方法内部自行处理异常，避免影响 Task 进程

```php
use Swlib\Exception\AppException;use Swlib\Table\Attributes\Transaction;use Swlib\TaskProcess\Attribute\TaskAttribute;

class DataSyncService
{
    #[TaskAttribute(
        name: '同步用户数据',
        timeout: 600
    )]
    #[Transaction]
    public static function syncUser(int $userId): void
    {
        try {
            $user = new UserTable()->where([UserTable::ID => $userId])->selectOne();
            if (!$user) {
                return;  // 用户不存在，直接返回
            }

            // 同步逻辑
            $this->doSync($user);

        } catch (AppException $e) {
            // 业务异常，记录日志后不再抛出
            Log::error("同步用户数据失败: {$e->getMessage()}");
        }
    }
}
```
