## 1. 框架概述

SWLib 是一个基于 PHP 8.4+ 和 Swoole 的现代化高性能 Web 开发框架，专为构建企业级应用而设计。

### 1.1 核心特性

- **现代 PHP**: 基于 PHP 8.4+ 注解特性，充分利用现代 PHP 语言特性
- **高性能**: 集成 Swoole 协程服务器，支持高并发处理
- **完整的 ORM**: 自动生成 Table 和 DTO 类，支持复杂查询、事务、缓存
- **AOP 支持**: 内置切面编程，支持日志、缓存、性能监控等横切关注点
- **后台管理**: 开箱即用的后台管理系统，支持 RBAC 权限控制
- **事件驱动**: 强大的事件系统，支持异步、队列、延迟执行
- **进程管理**: 自定义进程支持，适合后台任务处理
- **连接池**: MySQL 和 Redis 连接池，提升数据库访问性能
- **Protobuf**: 自动生成 Protobuf 协议文件，支持高效的数据传输
- **中间件**: 灵活的中间件系统，支持认证、权限、日志等
### 1.2 架构特点

- **代码生成**: 基于数据库结构自动生成 Table、DTO、Model、Admin 等代码
- **注解驱动**: 使用 PHP 8.4+ 注解定义路由、事件、进程、AOP 等
- **协程友好**: 全面支持 Swoole 协程，提供协程上下文管理
- **类型安全**: 强类型设计，充分利用 PHP 类型系统

### 1.3 框架目录结构

```
Swlib/
├── Admin/                 # 后台管理系统
│   ├── Action/            # 操作按钮和批量操作
│   ├── Config/            # 页面配置类
│   ├── Controller/        # 后台控制器
│   ├── Exception/         # 后台异常
│   ├── Fields/            # 表单字段类型
│   ├── Interface/         # 接口定义
│   ├── Manager/           # 管理器（列表行、选项等）
│   ├── Menu/              # 菜单组件
│   ├── Middleware/        # 中间件
│   ├── Templates/         # 模板文件
│   ├── Trait/             # Trait 复用代码
│   └── static/            # 静态资源
├── Aop/                   # 面向切面编程
│   ├── Abstract/          # 抽象切面基类
│   ├── Aspects/           # 内置切面（日志、缓存、性能等）
│   ├── Interface/         # 切面接口
│   └── JoinPoint.php      # 连接点类
├── App.php                # 应用入口类
├── Attribute/             # 注解定义
├── Connect/               # 连接管理（MySQL/Redis）
├── Controller/            # 控制器基类和内置控制器
│   ├── Abstract/          # 抽象控制器
│   ├── Config/            # 配置控制器
│   ├── File/              # 文件上传控制器
│   └── Language/          # 语言控制器
├── Coroutine/             # 协程支持
├── Crontab/               # 定时任务调度
├── DataManager/           # 数据管理（上下文、反射等）
├── DevTool/               # 开发工具
├── Enum/                  # 枚举定义
├── Event/                 # 事件系统
├── Exception/             # 异常类
├── Lock/                  # 锁机制（Worker锁、Redis锁）
├── Parse/                 # 代码解析生成
│   ├── Config/            # 配置解析
│   ├── Router/            # 路由解析和API生成
│   ├── Table/             # 表结构解析和代码生成
│   ├── ast/               # AST 编译
│   └── Helper/            # 辅助类
├── Process/               # 自定义进程
├── Proxy/                 # 代理系统
├── Queue/                 # 消息队列
├── Request/               # 请求处理
├── Response/              # 响应类型
├── Router/                # 路由系统
├── ServerEvents/          # Swoole 服务器事件
├── Table/                 # ORM 核心实现
├── TaskProcess/           # Task 进程调度
└── Utils/                 # 工具类库
```

### 1.4 启动流程

框架启动时执行以下步骤：

```php
// 1. 配置解析阶段
new ParseConfig();           // 解析 .env 配置
new ParseDatabaseConfig();   // 解析数据库配置
ConfigValidator::validate(); // 验证配置有效性

// 2. 代码生成阶段（在独立进程中执行）
new ParseAdminScaffold();    // 解析后台配置
new ParseTable();            // 解析表结构，生成 Table/DTO/Model
new ParseRouter();           // 解析路由，生成 API 代码
new ParseCrontab();          // 解析定时任务
new ParseEvent();            // 解析事件监听器
new ParseProcess();          // 解析自定义进程
new AstCompiler();           // 编译 AOP 代理类

// 3. 服务器启动阶段
$server->set($config);       // 配置 Swoole 服务器
ServerEventManager::bindEvents($server);  // 绑定服务器事件
Process::run($server);       // 添加自定义进程
CrontabScheduler::run($server); // 添加定时任务调度
$server->start();            // 启动服务器
```

**解析步骤详解**：

| 步骤 | 说明 | 生成内容 |
|------|------|----------|
| 删除模板缓存 | 清理 Twig 缓存 | - |
| 删除编译文件 | 清理旧的代理类 | - |
| 解析后台配置 | 扫描 AdminConfig 类 | 菜单、路由配置 |
| 解析表格字段 | 扫描数据库表结构 | Table、DTO、Model 类 |
| 解析开发工具路由 | 注册调试工具 | 路由映射 |
| 解析项目路由 | 扫描控制器注解 | 路由映射、API 代码 |
| 复制 Proto 文件 | 复制到 protos 目录 | .proto 文件 |
| 解析自定义进程 | 扫描 Process 注解 | 进程配置 |
| 解析定时任务 | 扫描 Crontab 注解 | 任务配置 |
| 解析事件管理器 | 扫描 Event 注解 | 事件监听器 |
| 编译 AOP 代理类 | AST 编译代理类 | Proxy 类 |
| 备份数据库 | 执行 create_tab.sql | 系统表 |
| 翻译入库 | I18n 翻译数据 | 翻译记录 |
| 移动静态文件 | 复制后台静态资源 | 前端资源 |
