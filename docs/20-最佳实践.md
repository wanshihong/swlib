## 20. 最佳实践

本章节提供使用 SWLib 框架开发应用时的最佳实践建议。

### 20.1 代码组织

#### 目录结构建议

```
App/
├── Controller/          # 控制器
│   ├── Api/            # API 控制器
│   └── Admin/          # 后台控制器
├── Service/            # 服务层
├── Model/              # 模型层
├── Event/              # 事件
│   ├── Events/         # 事件定义
│   └── Listeners/      # 事件监听器
├── Process/            # 自定义进程
├── Middleware/         # 中间件
└── Utils/              # 工具类
```

#### 命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| 类名 | PascalCase | `UserController` |
| 方法名 | camelCase | `getUserInfo` |
| 常量 | UPPER_SNAKE_CASE | `MAX_RETRY_COUNT` |
| 变量 | camelCase | `$userId` |

### 20.2 ORM 使用规范

#### 优先使用 DTO 对象

```php
// ✅ 推荐：使用 DTO 对象
$user = new UserTable()->where([UserTable::ID => $id])->selectOne();
echo $user->username;

// ❌ 避免：使用数组
$user = new UserTable()->where([UserTable::ID => $id])->selectOne()->toArray();
echo $user['username'];
```

#### 只查询需要的字段

```php
// ✅ 推荐：只查询需要的字段
$user = new UserTable()
    ->field([UserTable::ID, UserTable::USERNAME, UserTable::EMAIL])
    ->where([UserTable::ID => $id])
    ->selectOne();

// ❌ 避免：查询所有字段
$user = new UserTable()->where([UserTable::ID => $id])->selectOne();
```

#### 使用 DTO 转换 Protobuf

```php
// ✅ 推荐：使用格式化方法
$user = new UserTable()->where([UserTable::ID => $id])->selectOne();
return UserModel::formatItem($user);

// ❌ 避免：手动转换
$proto = new UserProto();
$proto->setId($user->id);
$proto->setUsername($user->username);
// ...
```

### 20.3 异常处理规范

#### 始终使用 AppErr 常量

```php
// ✅ 推荐：使用 AppErr 常量
throw new AppException(AppErr::PARAM_ERROR);

// ❌ 避免：硬编码消息
throw new AppException('参数错误');
```

#### 选择正确的异常类型

| 场景 | 异常类型 |
|------|----------|
| 一般错误 | `AppException` |
| 用户未登录 | `UnauthorizedException` |
| Token 过期 | `TokenExpiredException` |
| 需要重定向 | `RedirectException` |

### 20.4 性能优化

#### 数据库查询优化

```php
// 使用缓存
$users = new UserTable()
    ->where([UserTable::STATUS => 1])
    ->cache(300)  // 缓存 5 分钟
    ->selectAll();

// 使用分页
$users = new UserTable()
    ->page(1, 20)
    ->selectAll();
```

#### 连接池使用

```php
// ✅ 推荐：使用连接池
PoolRedis::call(function (Redis $redis) {
    return $redis->get('key');
});

// 缓存辅助
PoolRedis::getSet(
    key: 'cache_key',
    call: fn() => new UserTable()->selectAll(),
    expire: 3600
);
```

### 20.5 安全建议

#### 输入验证

```php
class UserController extends AbstractController
{
    public function update(): Success
    {
        // 验证输入
        $id = $this->get('id', '用户ID不能为空');
        $username = $this->post('username', '用户名不能为空');

        // 验证权限
        if (!$this->canEditUser($id)) {
            throw new AppException(AppErr::ADMIN_PERMISSION_DENIED);
        }

        // 更新数据
        new UserTable()->where([UserTable::ID => $id])->update([
            UserTable::USERNAME => $username
        ]);

        return new Success();
    }
}
```

#### SQL 注入防护

```php
// ✅ 推荐：使用参数化查询
$users = new UserTable()->where([
    [UserTable::NAME, 'like', "%{$keyword}%"]
])->selectAll();

// ❌ 避免：字符串拼接
$sql = "SELECT * FROM users WHERE name LIKE '%{$keyword}%'";
```

### 20.6 代码风格

#### 避免不必要的括号

```php
// ✅ 推荐：简洁风格
echo "welcome $name";

// ❌ 避免：不必要的括号
echo "welcome {$name}";

// ✅ 推荐：省略 new 调用周围的圆括号
$user = new UserTable();

// ❌ 避免：多余的括号
$user = (new UserTable());
```

#### 常量使用

```php
// ✅ 推荐：使用字段常量
new UserTable()->field([UserTable::ID, UserTable::USERNAME]);

// ❌ 避免：使用字符串
new UserTable()->field(['id', 'username']);
```

### 20.7 项目规范参考

- **API 设计**: 每个 API 独立一个类，私有方法放在 run 下方
- **服务层**: 除非特别通用，多个地方用到的服务才设计服务层 Service
- **异常处理**: backed/App 里的文件使用 backed/App/Exception/AppErr.php；backed/Swlib 里面的文件使用 backed/Swlib/Exception/AppErr.php
- **文案管理**: 前端的所有文案也要使用统一的文案管理类
- **禁止修改**: 不要修改 backed/runtime 和 backed/protos 里面的文件（框架自动生成）

---

## 总结

SWLib 是一个功能完整、性能优异的现代 PHP 框架，提供了：

- **高性能**: 基于 Swoole 协程，支持高并发
- **完整的 ORM**: 自动生成、类型安全、功能丰富
- **现代化设计**: PHP 8.4+ 注解、AOP、事件驱动
- **开箱即用**: 后台管理、权限控制、队列系统
- **企业级特性**: 连接池、缓存、监控、日志

通过本文档，您可以快速上手并充分利用 SWLib 框架的各项功能来构建高质量的 Web 应用。

---

**文档版本**: 3.0
**最后更新**: 2026-01-29
**框架版本**: SWLib 3.x
**PHP 版本要求**: >= 8.4
**Swoole 版本要求**: >= 6.0.0
