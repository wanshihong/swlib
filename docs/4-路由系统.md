## 4. 路由系统

SWLib 使用基于注解的路由系统，支持 RESTful API、中间件、参数验证等特性。

### 4.1 路由注解规则

框架的路由注解支持两种定义方式，按以下优先级解析：

| 场景 | 行为 |
|------|------|
| 控制器有注解 | 所有**公开方法**都会生成路由 |
| 控制器无注解 | 只为带注解的**单个方法**生成路由 |
| 控制器和方法都有注解 | **方法注解覆盖控制器注解** |

#### 方式一：控制器级别注解

在控制器上定义 `#[Router]` 注解，所有公开方法都会自动生成路由：

```php
use Swlib\Controller\Abstract\AbstractController;
use Swlib\Router\Router;

#[Router(method: 'POST')]
class UserController extends AbstractController
{
    // 方法会继承控制器的 method: 'POST'
    public function info(): UserProto
    {
        // 生成路由: POST /user/info
    }

    public function list(): UserListsProto
    {
        // 生成路由: POST /user/list
    }

    // 私有方法不会生成路由
    private function helper(): void
    {
    }
}
```

#### 方式二：方法级别注解

只在方法上定义 `#[Router]` 注解，控制器无需注解：

```php
use Swlib\Controller\Abstract\AbstractController;
use Swlib\Router\Router;

class UserController extends AbstractController
{
    #[Router(method: 'GET', url: '/user/info')]
    public function info(): UserProto
    {
        // 生成路由: GET /user/info
    }

    #[Router(method: 'POST', url: '/user/create')]
    public function create(): UserProto
    {
        // 生成路由: POST /user/create
    }

    // 没有注解的方法不会生成路由
    public function helper(): void
    {
    }
}
```

#### 方式三：混合定义（方法覆盖控制器）

控制器和方法都有注解时，方法注解会覆盖控制器注解：

```php
use Swlib\Controller\Abstract\AbstractController;
use Swlib\Router\Router;

#[Router(method: 'POST')]
class UserController extends AbstractController
{
    // 没有注解，继承控制器的 method: 'POST'
    public function list(): UserListsProto
    {
        // 生成路由: POST /user/list
    }

    // 有注解，覆盖控制器的 method
    #[Router(method: 'GET')]
    public function info(): UserProto
    {
        // 生成路由: GET /user/info (覆盖了 POST)
    }

    // 有注解，覆盖控制器的 method 和 url
    #[Router(method: 'DELETE', url: '/api/user/delete')]
    public function delete(): Success
    {
        // 生成路由: DELETE /api/user/delete
    }
}
```

### 4.2 Router 注解参数

```php
#[Router(
    method: 'POST',              // HTTP 方法，支持字符串或数组
    url: '/api/user/info',       // 自定义 URL（可选，默认根据类名和方法名生成）
    cache: 300,                  // 客户端缓存时间（秒）
    errorTitle: '操作失败',       // 错误提示标题
    middleware: [                // 中间件列表
        AuthMiddleware::class,
        LogMiddleware::class
    ]
)]
```

| 参数 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `method` | string\|array | HTTP 请求方法 | `'POST'` 或 `['GET', 'POST']` |
| `url` | string | 自定义 URL 路径 | `'/api/user/info'` |
| `cache` | int | 客户端缓存时间（秒） | `300` |
| `errorTitle` | string | 错误提示标题 | `'操作失败'` |
| `middleware` | array | 中间件类列表 | `[AuthMiddleware::class]` |

### 4.3 URL 生成规则

当不指定 `url` 参数时，框架会根据类名和方法名自动生成 URL：

```php
// 控制器: UserController
// 方法: info
// 生成 URL: /user/info

// 控制器: OrderItemList
// 方法: getLists
// 生成 URL: /order-item/get-lists
```

### 4.4 请求处理

#### 获取请求参数

```php
class UserController extends AbstractController
{
    public function update(): Success
    {
        // GET 参数
        $id = $this->get('id', '参数错误');
        $page = $this->get('page', '', 1);  // 带默认值

        // POST 参数
        $name = $this->post('name', '姓名不能为空');
        $email = $this->post('email', '', 'default@example.com');

        // Header 参数
        $token = $this->getHeader('authorization');

        return new Success();
    }
}
```

#### Protobuf 请求

```php
#[Router(method: 'POST')]
class UserController extends AbstractController
{
    public function create(UserProto $request): UserProto
    {
        // 自动解析 Protobuf 请求体
        $username = $request->getUsername();
        $email = $request->getEmail();

        // 业务逻辑处理
        $id = new UserTable()->insert([
            UserTable::USERNAME => $username,
            UserTable::EMAIL => $email
        ]);

        // 返回 Protobuf 响应
        return UserModel::formatItem(
            new UserTable()->where([UserTable::ID => $id])->selectOne()
        );
    }
}
```

### 4.5 响应类型

```php
use Swlib\Response\JsonResponse;
use Swlib\Response\TwigResponse;
use Swlib\Response\RedirectResponse;

class IndexController extends AbstractController
{
    // JSON 响应
    public function api(): JsonResponse
    {
        return JsonResponse::success(['message' => 'Hello World']);
    }

    // 模板响应
    #[Router(method: 'GET', url: '/')]
    public function index(): TwigResponse
    {
        return TwigResponse::render('index.twig', [
            'title' => '欢迎页面'
        ]);
    }

    // 重定向响应
    public function redirect(): RedirectResponse
    {
        return RedirectResponse::url('/dashboard');
    }
}
```

### 4.6 中间件

```php
use Swlib\Router\RouterMiddleware;

class AuthMiddleware implements RouterMiddleware
{
    public function handle(): mixed
    {
        $token = $this->getHeader('authorization');

        if (empty($token)) {
            return JsonResponse::error('未授权访问', 401);
        }

        // 验证 token 并存储到上下文
        $user = $this->validateToken($token);
        CtxEnum::CurrentUser->set($user);

        return true; // 继续执行
    }
}

// 应用中间件
#[Router(
    method: 'POST',
    middleware: [AuthMiddleware::class]
)]
class ApiController extends AbstractController
{
    // 所有方法都需要认证
}
```
