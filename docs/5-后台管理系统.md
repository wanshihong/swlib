## 5. 后台管理系统

SWLib 提供了完整的后台管理系统，支持快速创建 CRUD 界面。后台系统基于模块化设计，包含必要的配置类、基础控制器和丰富的字段类型。

### 5.1 后台系统架构

#### 核心组件

1. **AdminConfig**: 后台配置类，定义菜单、路由和基本设置
2. **Dashboard**: 后台首页控制器
3. **Login**: 登录认证控制器
4. **AbstractAdmin**: 后台管理控制器基类

#### 目录结构

```
App/AdminXsom756/
├── AdminConfig.php          # 后台配置类
├── Dashboard.php           # 后台首页控制器
├── Login.php              # 登录控制器
├── User/                  # 用户管理模块
│   ├── UserAdmin.php
│   ├── UserScoreAdmin.php
│   └── ...
└── System/               # 系统管理模块
    ├── ConfigAdmin.php
    ├── AdminManagerAdmin.php
    └── ...
```

### 5.2 创建后台配置 (AdminConfig)

**必须创建** `AdminConfig` 类来配置后台系统的基本设置：

```php
<?php

namespace App\AdminXsom756;

use App\Apps\Live\LiveConfig;
use Generate\RouterPath;
use Generate\Tables\Wenyuehui\ConfigTable;
use Swlib\Admin\Config\AdminConfigAbstract;
use Swlib\Admin\Manager\AdminManager;
use Swlib\Admin\Menu\Menu;
use Swlib\Admin\Menu\MenuGroup;
use Swlib\Admin\Utils\Func;

class AdminConfig extends AdminConfigAbstract
{
    const int AppId = LiveConfig::AppId;

    public function Init(AdminManager $layout): void
    {
        // 首页地址
        $layout->adminIndexUrl = RouterPath::AdminXsom756DashboardIndex;

        // 登录相关路由
        $layout->logoutUrl = RouterPath::AdminXsom756LoginLogout;
        $layout->loginUrl = RouterPath::AdminXsom756LoginLogin;
        $layout->changePasswordUrl = RouterPath::AdminXsom756LoginChangePassword;
        $layout->noAccessUrl = RouterPath::AdminXsom756DashboardNoAccess;

        // 文件上传路由
        $layout->uploadUrl = Url::generateUrl(RouterPath::AppsCommonFileUpload, [
            'appid' => AdminConfig::AppId
        ]);
    }

    public function configAdminTitle(): string
    {
        return '管理后台';
    }

    public function configMenus(): array
    {
        return [
            new MenuGroup(label: '用户管理', icon: 'bi bi-chevron-double-right')->setMenus(
                new Menu(label: '用户账号', url: RouterPath::AdminXsom756UserUserAdminLists),
                new Menu(label: '登录日志', url: RouterPath::AdminXsom756UserUserLoginHisAdminLists),
                new Menu(label: '账户日志', url: RouterPath::AdminXsom756UserUserScoreLogAdminLists),
                new Menu(label: '提现管理', url: RouterPath::AdminXsom756UserUserWithdrawAdminLists),
            ),

            new MenuGroup(label: '系统管理', icon: 'bi bi-chevron-double-right')->setMenus(
                new Menu(label: '管理员', url: RouterPath::AdminXsom756SystemAdminManagerAdminLists),
                new Menu(label: '系统配置', url: RouterPath::AdminXsom756SystemConfigAdminLists,
                    params: [ConfigTable::APP_ID => AdminConfig::AppId]),
                new Menu(label: '翻译配置', url: RouterPath::AdminXsom756SystemLanguageAdminLists),
                new Menu(label: '页面配置', url: RouterPath::AdminXsom756SystemRouterAdminLists),
            ),
        ];
    }
}
```

**AdminConfig 配置说明**：

- **AppId**: 应用ID常量，用于数据隔离
- **Init()**: 配置后台系统的基本路由和设置
- **configAdminTitle()**: 设置后台标题
- **configMenus()**: 配置左侧菜单结构

### 5.3 创建基础控制器

#### Dashboard 控制器

```php
<?php

namespace App\AdminXsom756;

class Dashboard extends \Swlib\Admin\Controller\Dashboard
{
    // 继承基础 Dashboard 类即可
    // 可以重写 index() 方法自定义首页内容
}
```

#### Login 控制器

```php
<?php

namespace App\AdminXsom756;

class Login extends \Swlib\Admin\Controller\LoginAdmin
{
    // 继承基础 Login 类即可
    // 包含登录、注册、修改密码、退出登录等功能
}
```

**基础控制器功能**：

- **Dashboard**: 提供后台首页和无权限页面
- **Login**: 提供完整的认证功能
  - `login()`: 登录页面和登录处理
  - `register()`: 注册功能
  - `changePassword()`: 修改密码
  - `logout()`: 退出登录

### 5.4 创建后台管理控制器

```php
<?php

namespace App\AdminXsom756\Controller\User;

use App\AdminXsom756\Controller\AdminConfig;use Generate\Models\Wenyuehui\UserModel;use Generate\Tables\Wenyuehui\UserTable;use Generate\TablesDto\Wenyuehui\UserTableDto;use Swlib\Admin\Config\PageConfig;use Swlib\Admin\Config\PageFieldsConfig;use Swlib\Admin\Controller\Abstract\AbstractAdmin;use Swlib\Admin\Fields\HiddenField;use Swlib\Admin\Fields\Int2TimeField;use Swlib\Admin\Fields\NumberField;use Swlib\Admin\Fields\SelectField;use Swlib\Admin\Fields\TextField;use Swlib\Admin\Manager\OptionManager;use Swlib\Table\Interface\TableInterface;

class UserAdmin extends AbstractAdmin
{
    protected function configPage(PageConfig $config): void
    {
        $config->pageName = "登录用户";
        $config->tableName = UserTable::class;
        $config->order = [
            UserTable::ID => 'desc'
        ];
    }

    public function listsQuery(TableInterface $query): void
    {
        // 数据权限控制：只显示当前应用的用户
        $query->addWhere(UserTable::APP_ID, AdminConfig::AppId);
    }

    protected function configField(PageFieldsConfig $fields): void
    {
        $fields->setFields(
            new NumberField(field: UserTable::ID, label: 'ID')->hideOnForm(),
            new HiddenField(field: UserTable::APP_ID, label: 'AppId')
                ->setDefault(AdminConfig::AppId),
            new TextField(field: UserTable::PHONE, label: '手机号码')
                ->setRequired(false),
            new TextField(field: UserTable::USERNAME, label: '用户名')
                ->setRequired(false),
            new TextField(field: UserTable::PASSWORD, label: '密码')
                ->setRequired(false),
            new TextField(field: UserTable::EMAIL, label: '邮箱')
                ->setRequired(false),
            new SelectField(field: UserTable::STATUS, label: '状态')->setOptions(
                new OptionManager(UserModel::StatusActive,
                    UserModel::StatusTextMaps[UserModel::StatusActive]),
                new OptionManager(UserModel::StatusInactive,
                    UserModel::StatusTextMaps[UserModel::StatusInactive]),
                new OptionManager(UserModel::StatusDisabled,
                    UserModel::StatusTextMaps[UserModel::StatusDisabled]),
            ),
            new NumberField(field: UserTable::SHARE_RATIO, label: '分销比例')
                ->setRequired(false)->hideOnFilter(),
            new Int2TimeField(field: UserTable::LAST_LOGIN_TIME, label: '上次登录时间')
                ->hideOnForm()->hideOnFilter(),
            new Int2TimeField(field: UserTable::REG_AT, label: '注册时间')
                ->hideOnForm()->hideOnFilter(),
        );
    }

    public function insertUpdateBefore(UserTableDto $dto): void
    {
        // 密码加密处理
        if ($dto->password && !str_starts_with($dto->password, '$2y$')) {
            $dto->password = password_hash($dto->password, PASSWORD_DEFAULT);
        }
    }
}
```

#### 核心方法说明

- **configPage()**: 配置页面基本信息
  - `pageName`: 页面标题
  - `tableName`: 关联的数据表类
  - `order`: 默认排序规则

- **listsQuery()**: 自定义查询条件
  - 用于数据权限控制
  - 添加额外的查询条件

- **configField()**: 配置字段
  - 定义表单字段和列表显示字段
  - 设置字段属性和验证规则

- **insertUpdateBefore()**: 数据保存前的处理
  - 数据验证和转换
  - 业务逻辑处理

#### 高级配置示例

```php
class ConfigAdmin extends AbstractAdmin
{
    protected function configPage(PageConfig $config): void
    {
        $config->pageName = "系统配置";
        $config->tableName = ConfigTable::class;
        $config->order = [
            ConfigTable::APP_ID => 'desc',
            ConfigTable::KEY => 'asc',
            ConfigTable::ID => 'desc'
        ];
    }

    public function listsQuery(TableInterface $query): void
    {
        $query->addWhere(ConfigTable::APP_ID, AdminConfig::AppId);
    }

    public function configAction(ActionsConfig $actions): void
    {
        // 禁用默认编辑按钮
        $actions->disabledActions = [ActionDefaultButtonEnum::EDIT];

        // 添加自定义操作按钮
        $actions->addActions(
            new Action(label: '编辑', url: 'edit', params: [
                ConfigTable::VALUE_TYPE => '%' . ConfigTable::VALUE_TYPE,
            ])->showList()->showDetail()->setSort(1)
                ->setTemplate('action/action-alink.twig')->setIcon('bi bi-pencil'),
        );
    }

    protected function configField(PageFieldsConfig $fields): void
    {
        // 根据参数动态配置字段
        $valueType = $this->get(ConfigTable::VALUE_TYPE, '', 'txt');

        if ($valueType === 'txt') {
            $valueConfig = new TextareaField(field: ConfigTable::VALUE, label: '配置')->hideOnFilter();
        } elseif ($valueType === 'time') {
            $valueConfig = new Int2TimeField(field: ConfigTable::VALUE, label: '配置')->hideOnFilter();
        } elseif ($valueType === 'number') {
            $valueConfig = new NumberField(field: ConfigTable::VALUE, label: '配置')->hideOnFilter();
        } elseif ($valueType === 'url') {
            $valueConfig = new UrlField(field: ConfigTable::VALUE, label: '配置')->hideOnFilter();
        } else {
            $valueConfig = new ImageField(field: ConfigTable::VALUE, label: '配置')->hideOnFilter();
        }

        $isEdit = $this->pagePos === PagePosEnum::FORM_EDIT;

        $fields->setFields(
            new NumberField(field: ConfigTable::ID, label: 'ID')->hideOnForm()->hideOnList(),
            new TextField(field: ConfigTable::KEY, label: '配置唯一标识')
                ->setListMaxWidth(200)->setDisabled($isEdit),
            new TextField(field: ConfigTable::DESC, label: '配置说明')
                ->hideOnFilter()->setListMaxWidth(200),
            $valueConfig,
            new SwitchField(field: ConfigTable::IS_ENABLE, label: '是否启用')
                ->hideOnForm()->hideOnFilter(),
            new HiddenField(field: ConfigTable::APP_ID, label: '应用ID')
                ->setFilterDefault(AdminConfig::AppId)->setDefault(AdminConfig::AppId),
        );
    }

    public function insertUpdateAfter(ConfigTableDto $table): void
    {
        // 数据保存后清除缓存
        ConfigService::clearCache(AdminConfig::AppId, $table->key);
    }
}
```

### 5.5 字段类型

#### 基础字段

```php
// 文本字段
new TextField(field: UserTable::USERNAME, label: '用户名')
    ->setRequired(true)
    ->setPlaceholder('请输入用户名');

// 数字字段
new NumberField(field: UserTable::AGE, label: '年龄')
    ->setMin(0)
    ->setMax(150);

// 密码字段
new PasswordField(field: UserTable::PASSWORD, label: '密码');

// 文本域
new TextareaField(field: UserTable::DESCRIPTION, label: '描述');

// 开关字段
new SwitchField(field: UserTable::IS_ACTIVE, label: '是否激活');
```

#### 选择字段

```php
// 下拉选择
new SelectField(field: UserTable::GENDER, label: '性别')->setOptions(
    new OptionManager('male', '男'),
    new OptionManager('female', '女')
);

// 关联选择（外键关联）
new SelectField(field: UserTable::CATEGORY_ID, label: '分类')
    ->setRelation(
        CategoryTable::class,    // 关联表
        CategoryTable::ID,       // 关联表主键
        CategoryTable::NAME      // 显示字段
    );

// 多选字段
new CheckboxField(field: UserTable::TAGS, label: '标签')->setOptions(
    new OptionManager('tag1', '标签1'),
    new OptionManager('tag2', '标签2')
);
```

#### 特殊字段

```php
// 图片上传
new ImageField(field: UserTable::AVATAR, label: '头像');

// 文件上传
new FileField(field: UserTable::ATTACHMENT, label: '附件');

// 日期时间
new DateTimeField(field: UserTable::BIRTHDAY, label: '生日');

// 时间戳转换
new Int2TimeField(field: UserTable::CREATED_AT, label: '创建时间');

// 颜色选择
new ColorField(field: UserTable::THEME_COLOR, label: '主题色');
```

### 5.6 字段属性和方法

#### 通用字段属性

```php
// 字段显示控制
new TextField(field: UserTable::USERNAME, label: '用户名')
    ->hideOnForm()        // 在表单中隐藏
    ->hideOnList()        // 在列表中隐藏
    ->hideOnFilter()      // 在筛选中隐藏
    ->onlyOnForm()        // 只在表单中显示
    ->onlyOnList()        // 只在列表中显示
    ->onlyOnFilter();     // 只在筛选中显示

// 字段验证
new TextField(field: UserTable::EMAIL, label: '邮箱')
    ->setRequired(true)           // 必填
    ->setPlaceholder('请输入邮箱')  // 占位符
    ->setDisabled(true)           // 禁用编辑
    ->setReadonly(true);          // 只读

// 列表显示控制
new TextField(field: UserTable::DESCRIPTION, label: '描述')
    ->setListMaxWidth(200)        // 列表最大宽度
    ->setListEllipsis(true);      // 超长省略

// 默认值设置
new NumberField(field: UserTable::STATUS, label: '状态')
    ->setDefault(1)               // 表单默认值
    ->setFilterDefault(1);        // 筛选默认值
```

#### 特殊字段配置

```php
// 图片上传字段
new ImageField(field: UserTable::AVATAR, label: '头像')
    ->setUploadPath('/uploads/avatars/')  // 上传路径
    ->setMaxSize(2048)                    // 最大文件大小(KB)
    ->setAllowedTypes(['jpg', 'png']);    // 允许的文件类型

// 文件上传字段
new FileField(field: UserTable::ATTACHMENT, label: '附件')
    ->setUploadPath('/uploads/files/')
    ->setMaxSize(10240)
    ->setAllowedTypes(['pdf', 'doc', 'docx']);

// URL 字段
new UrlField(field: UserTable::WEBSITE, label: '网站')
    ->setOpenInNewTab(true);              // 在新标签页打开

// 时间戳字段
new Int2TimeField(field: UserTable::CREATED_AT, label: '创建时间')
    ->setFormat('Y-m-d H:i:s');           // 时间格式

// 数字字段
new NumberField(field: UserTable::PRICE, label: '价格')
    ->setMin(0)                           // 最小值
    ->setMax(99999)                       // 最大值
    ->setStep(0.01)                       // 步长
    ->setPrefix('￥')                      // 前缀
    ->setSuffix('元');                     // 后缀
```

### 5.7 权限控制和数据隔离

#### 数据权限控制

```php
class UserAdmin extends AbstractAdmin
{
    public function listsQuery(TableInterface $query): void
    {
        // 应用级数据隔离
        $query->addWhere(UserTable::APP_ID, AdminConfig::AppId);

        // 用户级数据隔离
        if (!$this->hasRole('ROLE_ADMIN')) {
            $query->addWhere(UserTable::CREATED_BY, $this->getCurrentUserId());
        }

        // 状态过滤
        $query->addWhere(UserTable::STATUS, '!=', -1);
    }

    public function editQuery(TableInterface $query): void
    {
        // 编辑权限控制
        $query->addWhere(UserTable::STATUS, 1);
    }

    public function deleteQuery(TableInterface $query): void
    {
        // 删除权限控制
        $query->addWhere(UserTable::STATUS, '!=', 1);
    }
}
```

#### 字段级权限控制

```php
protected function configField(PageFieldsConfig $fields): void
{
    $fields->setFields(
        new TextField(field: UserTable::USERNAME, label: '用户名'),

        // 根据角色显示不同字段
        new SelectField(field: UserTable::STATUS, label: '状态')
            ->setOptions(
                new OptionManager(1, '启用'),
                new OptionManager(0, '禁用')
            )
            ->setVisible($this->hasRole('ROLE_ADMIN')),  // 只有管理员可见

        // 根据条件禁用字段
        new TextField(field: UserTable::EMAIL, label: '邮箱')
            ->setDisabled($this->pagePos === PagePosEnum::FORM_EDIT),
    );
}
```

### 5.8 事件钩子

后台管理系统提供了完整的事件钩子，可以在数据操作的各个阶段进行自定义处理：

```php
class UserAdmin extends AbstractAdmin
{
    // 插入/更新前的统一处理
    public function insertUpdateBefore(UserTableDto $dto): void
    {
        // 密码加密
        if ($dto->password && !str_starts_with($dto->password, '$2y$')) {
            $dto->password = password_hash($dto->password, PASSWORD_DEFAULT);
        }

        // 数据验证
        if (empty($dto->username)) {
            throw new AppException('用户名不能为空');
        }
    }

    // 插入前处理
    public function insertBefore(UserTableDto $dto): void
    {
        $dto->createdBy = $this->getCurrentUserId();
        $dto->createdAt = time();
        $dto->appId = AdminConfig::AppId;
    }

    // 插入后处理
    public function insertAfter(UserTableDto $dto): void
    {
        // 清除相关缓存
        $this->clearUserCache($dto->id);

        // 发送通知
        $this->sendNotification('新用户注册', $dto->username);

        // 记录操作日志
        $this->logOperation('CREATE_USER', $dto->id);
    }

    // 更新前处理
    public function updateBefore(UserTableDto $dto): void
    {
        $dto->updatedBy = $this->getCurrentUserId();
        $dto->updatedAt = time();
    }

    // 更新后处理
    public function updateAfter(UserTableDto $dto): void
    {
        // 清除缓存
        $this->clearUserCache($dto->id);

        // 记录操作日志
        $this->logOperation('UPDATE_USER', $dto->id);
    }

    // 删除前处理
    public function deleteBefore(UserTableDto $dto): void
    {
        // 检查是否可以删除
        if ($dto->status === 1) {
            throw new AppException('激活状态的用户不能删除');
        }

        // 检查关联数据
        $orderCount = new OrderTable()->where([
            OrderTable::USER_ID => $dto->id
        ])->count();

        if ($orderCount > 0) {
            throw new AppException('该用户有关联订单，不能删除');
        }
    }

    // 删除后处理
    public function deleteAfter(UserTableDto $dto): void
    {
        // 清除缓存
        $this->clearUserCache($dto->id);

        // 删除关联数据
        new UserScoreTable()->where([
            UserScoreTable::USER_ID => $dto->id
        ])->delete();

        // 记录操作日志
        $this->logOperation('DELETE_USER', $dto->id);
    }

    // 插入/更新后的统一处理
    public function insertUpdateAfter(UserTableDto $dto): void
    {
        // 更新统计数据
        $this->updateUserStatistics();

        // 同步到其他系统
        $this->syncToExternalSystem($dto);
    }

    private function clearUserCache(int $userId): void
    {
        // 清除用户相关缓存
        Cache::delete("user:{$userId}");
        Cache::delete("user_profile:{$userId}");
    }

    private function logOperation(string $action, int $userId): void
    {
        // 记录操作日志
        new AdminLogTable()->insert([
            AdminLogTable::ADMIN_ID => $this->getCurrentUserId(),
            AdminLogTable::ACTION => $action,
            AdminLogTable::TARGET_ID => $userId,
            AdminLogTable::CREATED_AT => time()
        ]);
    }
}
```

#### 可用的事件钩子

| 钩子方法 | 触发时机 | 参数 | 说明 |
|---------|---------|------|------|
| `insertUpdateBefore()` | 插入/更新前 | `$dto` | 统一的前置处理 |
| `insertBefore()` | 插入前 | `$dto` | 插入特定的前置处理 |
| `insertAfter()` | 插入后 | `$dto` | 插入特定的后置处理 |
| `updateBefore()` | 更新前 | `$dto` | 更新特定的前置处理 |
| `updateAfter()` | 更新后 | `$dto` | 更新特定的后置处理 |
| `deleteBefore()` | 删除前 | `$dto` | 删除前的检查和处理 |
| `deleteAfter()` | 删除后 | `$dto` | 删除后的清理工作 |
| `insertUpdateAfter()` | 插入/更新后 | `$dto` | 统一的后置处理 |

### 5.9 Action 操作按钮与批量操作

后台操作按钮通过注解声明，系统会在渲染页面时自动收集并按位置显示。ActionButton 支持类级别与方法级别的注解，URL 相同的按钮会去重，子类优先生效。

#### 5.9.1 Action 位置枚举

```php
use Swlib\Admin\Action\Enum\ActionPosEnum;

ActionPosEnum::LISTS_PAGE;      // 列表页顶部按钮区
ActionPosEnum::LISTS_PAGE_ROW;  // 列表页表格行内按钮
ActionPosEnum::NEW_PAGE;        // 新建页面
ActionPosEnum::EDIT_PAGE;       // 编辑页面
ActionPosEnum::DETAIL_PAGE;     // 详情页面
```

#### 5.9.2 ActionButton 注解（普通操作按钮）

```php
use Swlib\Admin\Action\Attribute\ActionButton;
use Swlib\Admin\Action\Enum\ActionPosEnum;
use Swlib\Response\JsonResponse;

class UserAdmin extends AbstractAdmin
{
    #[ActionButton(label: "添加", url: "new", showOn: [ActionPosEnum::LISTS_PAGE], icon: "bi bi-plus", sort: 10)]
    public function new(): TwigResponse|RedirectResponse
    {
        return parent::new();
    }

    #[ActionButton(label: "编辑", showOn: [ActionPosEnum::LISTS_PAGE_ROW, ActionPosEnum::DETAIL_PAGE], icon: "bi bi-pencil", sort: 11)]
    public function edit(): TwigResponse|RedirectResponse
    {
        return parent::edit();
    }

    #[ActionButton(label: "删除", showOn: [ActionPosEnum::LISTS_PAGE_ROW, ActionPosEnum::DETAIL_PAGE], icon: "bi bi-trash", sort: 13, template: "action/action-alink-delete.twig", jsFiles: ['/admin/js/action-delete.js'])]
    public function delete(): RedirectResponse
    {
        return parent::delete();
    }

    #[ActionButton(label: "重置密码", url: "resetPassword", showOn: [ActionPosEnum::LISTS_PAGE_ROW], icon: "bi bi-key", sort: 20)]
    public function resetPassword(): JsonResponse
    {
        $id = $this->get('id', '请选择用户');
        return JsonResponse::success(['id' => $id]);
    }
}
```

ActionButton 可以写在类上或方法上：

- 写在方法上：适合当前控制器已有方法的按钮（如 edit、delete）。
- 写在类上：适合纯跳转到其他控制器或外部链接的按钮，无需新增方法。

```php
use Swlib\Admin\Action\Attribute\ActionButton;
use Swlib\Admin\Action\Enum\ActionPosEnum;

#[ActionButton(label: "去订单列表", url: "/admin/order/lists", showOn: [ActionPosEnum::LISTS_PAGE], icon: "bi bi-list")]
class UserAdmin extends AbstractAdmin
{
}
```

**常用参数说明**：

- **label**: 按钮文本
- **url**: 跳转地址或方法名；为空时默认使用当前方法名
- **showOn**: 显示位置（见 ActionPosEnum）
- **icon**: Bootstrap Icons 图标类名
- **sort**: 排序值，数字越小越靠前
- **target**: 跳转方式（默认 `_self`）
- **template**: 按钮渲染模板（默认 `action/action-alink.twig`）
- **enable**: 是否启用按钮
- **allowRoles**: 允许显示的角色列表
- **cssFiles/jsFiles**: 页面需要加载的静态资源
- **sourceUrl**: 来源页面 URL，用于左侧导航高亮

#### 5.9.3 params 占位符与请求参数

ActionButton 和 BatchAction 都支持 params 参数，支持占位符和请求参数替换：

- `%字段名`：替换为当前行字段值
- `get:参数名`：从 GET 参数读取
- `post:参数名`：从 POST 参数读取

```php
#[ActionButton(
    label: "查看详情",
    url: "detail",
    showOn: [ActionPosEnum::LISTS_PAGE_ROW],
    params: [
        "id" => "%id",
        "source" => "get:source",
    ]
)]
```

#### 5.9.4 BatchAction 注解（批量操作）

批量操作显示在列表页分页区域左侧，系统会自动加载 `/admin/js/batch-action.js`。

```php
use Swlib\Admin\Action\Attribute\BatchAction;
use Swlib\Response\JsonResponse;

class UserAdmin extends AbstractAdmin
{
    #[BatchAction(label: "批量启用", confirmMessage: "确定要启用选中的用户吗？", icon: "bi bi-check-circle", sort: 10)]
    public function batchEnable(): JsonResponse
    {
        $ids = $this->post('ids');
        return JsonResponse::success(['count' => count($ids)]);
    }

    #[BatchAction(label: "批量删除", confirmMessage: "确定要删除选中的数据吗？", icon: "bi bi-trash", sort: 20)]
    public function batchDelete(): JsonResponse
    {
        return parent::batchDelete();
    }
}
```

**BatchAction 常用参数**：

- **label**: 下拉菜单文本
- **url**: 批量操作地址；为空时默认使用方法名
- **confirmMessage**: 确认提示语
- **sort**: 排序值，数字越小越靠前
- **enable / allowRoles / jsFiles / cssFiles**: 与 ActionButton 一致

#### 5.9.5 禁用默认操作（DisableAction）

通过在控制器类上添加 DisableAction 注解，可以禁用默认操作方法。被禁用的方法不会显示按钮，并且无法访问。

```php
use Swlib\Admin\Controller\Attribute\DisableAction;
use Swlib\Admin\Controller\Enum\AdminActionEnum;

#[DisableAction(actions: [AdminActionEnum::DELETE, AdminActionEnum::NEW])]
class UserAdmin extends AbstractAdmin
{
}
```

可选自定义禁用提示：

```php
#[DisableAction(actions: [AdminActionEnum::DELETE], message: "该功能已被管理员禁用")]
class UserAdmin extends AbstractAdmin
{
}
```

### 5.10 后台管理最佳实践

#### 1. 项目结构组织

```
App/AdminXsom756/
├── AdminConfig.php              # 后台配置（必需）
├── Dashboard.php               # 首页控制器（必需）
├── Login.php                  # 登录控制器（必需）
├── User/                      # 用户管理模块
│   ├── UserAdmin.php
│   ├── UserScoreAdmin.php
│   └── UserLoginHisAdmin.php
├── System/                    # 系统管理模块
│   ├── ConfigAdmin.php
│   ├── AdminManagerAdmin.php
│   └── LanguageAdmin.php
└── Apps/                      # 业务模块
    ├── Live/
    │   ├── LiveRoomsAdmin.php
    │   └── LiveGiftItemsAdmin.php
    └── Video/
        ├── VideosAdmin.php
        └── VideoCommentsAdmin.php
```

#### 2. 命名规范

- **控制器命名**: `{模块名}Admin.php`
- **页面标题**: 使用中文，简洁明了
- **字段标签**: 使用中文，与业务术语保持一致
- **菜单组织**: 按业务模块分组，层级不超过3层

#### 3. 数据安全

```php
class UserAdmin extends AbstractAdmin
{
    public function listsQuery(TableInterface $query): void
    {
        // 1. 应用级数据隔离（必须）
        $query->addWhere(UserTable::APP_ID, AdminConfig::AppId);

        // 2. 软删除过滤
        $query->addWhere(UserTable::DELETED_AT, 'is null', '');

        // 3. 权限级数据过滤
        if (!$this->hasRole('ROLE_SUPER_ADMIN')) {
            $query->addWhere(UserTable::CREATED_BY, $this->getCurrentUserId());
        }
    }

    public function insertUpdateBefore(UserTableDto $dto): void
    {
        // 1. 数据验证
        if (empty($dto->username)) {
            throw new AppException('用户名不能为空');
        }

        // 2. 数据清理
        $dto->username = trim($dto->username);
        $dto->email = strtolower(trim($dto->email));

        // 3. 敏感数据处理
        if ($dto->password) {
            $dto->password = password_hash($dto->password, PASSWORD_DEFAULT);
        }

        // 4. 强制设置应用ID
        $dto->appId = AdminConfig::AppId;
    }
}
```

#### 4. 性能优化

```php
class UserAdmin extends AbstractAdmin
{
    protected function configField(PageFieldsConfig $fields): void
    {
        $fields->setFields(
            // 1. 大字段在列表中隐藏
            new TextareaField(field: UserTable::DESCRIPTION, label: '描述')
                ->hideOnList(),

            // 2. 时间字段在筛选中隐藏
            new Int2TimeField(field: UserTable::CREATED_AT, label: '创建时间')
                ->hideOnFilter(),

            // 3. 关联字段使用缓存
            new SelectField(field: UserTable::CATEGORY_ID, label: '分类')
                ->setRelation(CategoryTable::class, CategoryTable::ID, CategoryTable::NAME)
                ->setCacheTime(3600),  // 缓存1小时
        );
    }

    public function listsQuery(TableInterface $query): void
    {
        // 4. 只查询必要字段
        $query->field([
            UserTable::ID,
            UserTable::USERNAME,
            UserTable::EMAIL,
            UserTable::STATUS,
            UserTable::CREATED_AT
        ]);

        // 5. 合理的分页大小
        $this->pageSize = 20;
    }
}
```

#### 5. 用户体验

```php
protected function configField(PageFieldsConfig $fields): void
{
    $fields->setFields(
        // 1. 合理的字段顺序
        new NumberField(field: UserTable::ID, label: 'ID')->hideOnForm(),
        new TextField(field: UserTable::USERNAME, label: '用户名'),
        new TextField(field: UserTable::EMAIL, label: '邮箱'),

        // 2. 清晰的字段标签
        new SelectField(field: UserTable::STATUS, label: '账户状态')->setOptions(
            new OptionManager(1, '正常'),
            new OptionManager(0, '禁用'),
            new OptionManager(-1, '已删除')
        ),

        // 3. 合适的字段类型
        new SwitchField(field: UserTable::IS_VIP, label: 'VIP用户'),
        new Int2TimeField(field: UserTable::LAST_LOGIN_TIME, label: '最后登录'),

        // 4. 隐藏技术字段
        new HiddenField(field: UserTable::APP_ID, label: '应用ID')
            ->setDefault(AdminConfig::AppId),
    );
}
```

#### 6. 错误处理

```php
class UserAdmin extends AbstractAdmin
{
    public function insertUpdateBefore(UserTableDto $dto): void
    {
        try {
            // 业务逻辑处理
            $this->validateUserData($dto);
            $this->processUserData($dto);
        } catch (AppException $e) {
            // 业务异常直接抛出
            throw $e;
        } catch (Throwable $e) {
            // 系统异常记录日志并转换
            Log::error('用户数据处理失败', [
                'dto' => $dto,
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);
            throw new AppException('数据处理失败，请稍后重试');
        }
    }

    private function validateUserData(UserTableDto $dto): void
    {
        if (empty($dto->username)) {
            throw new AppException('用户名不能为空');
        }

        if (!filter_var($dto->email, FILTER_VALIDATE_EMAIL)) {
            throw new AppException('邮箱格式不正确');
        }

        // 检查用户名是否重复
        $exists = new UserTable()->where([
            [UserTable::USERNAME, '=', $dto->username],
            [UserTable::ID, '!=', $dto->id ?? 0]
        ])->exists();

        if ($exists) {
            throw new AppException('用户名已存在');
        }
    }
}
```

#### 7. 菜单配置技巧

```php
public function configMenus(): array
{
    return [
        // 1. 按业务模块分组
        new MenuGroup(label: '用户管理', icon: 'bi bi-people')->setMenus(
            new Menu(label: '用户账号', url: RouterPath::AdminXsom756UserUserAdminLists),
            new Menu(label: '用户积分', url: RouterPath::AdminXsom756UserUserScoreAdminLists),
            new Menu(label: '登录日志', url: RouterPath::AdminXsom756UserUserLoginHisAdminLists),
        ),

        // 2. 系统管理放在最后
        new MenuGroup(label: '系统管理', icon: 'bi bi-gear')->setMenus(
            new Menu(label: '管理员', url: RouterPath::AdminXsom756SystemAdminManagerAdminLists),
            new Menu(label: '系统配置', url: RouterPath::AdminXsom756SystemConfigAdminLists,
                params: [ConfigTable::APP_ID => AdminConfig::AppId]),  // 3. 传递必要参数
            new Menu(label: '操作日志', url: RouterPath::AdminXsom756SystemLogAdminLists),
        ),
    ];
}
```

#### 8. 开发调试

```php
class UserAdmin extends AbstractAdmin
{
    protected function configPage(PageConfig $config): void
    {
        $config->pageName = "用户管理";
        $config->tableName = UserTable::class;

        // 开发环境显示SQL调试
        if (APP_DEBUG) {
            $config->showSqlDebug = true;
        }
    }

    public function listsQuery(TableInterface $query): void
    {
        // 开发环境记录查询
        if (APP_DEBUG) {
            $query->setDebugSql();
        }

        $query->addWhere(UserTable::APP_ID, AdminConfig::AppId);
    }
}
```

通过以上配置和最佳实践，可以快速构建功能完整、安全可靠的后台管理系统。
        if ($dto->status === 1) {
            throw new AppException('激活用户不能删除');
        }
    }
}
```
