## 19. 异常处理

框架提供了一套完整的异常处理机制，支持自动翻译和多语言。

### 19.1 异常类

| 异常类 | 说明 | 状态码 |
|--------|------|--------|
| `AppException` | 应用异常（支持翻译） | 500 |
| `UnauthorizedException` | 未授权异常（用户未登录） | 401 |
| `TokenExpiredException` | Token 过期异常（自动刷新） | 419 |
| `RedirectException` | 重定向异常 | 302 |
| `LangException` | 语言异常（内部使用） | - |

### 19.2 AppErr 错误码常量

`AppErr` 类定义了框架所有错误码常量，使用 PHP 8.4+ `I18nAttribute` 注解支持自动翻译。

```php
use Swlib\Controller\Language\Enum\LanguageEnum;use Swlib\Exception\AppException;

// 抛出异常（自动翻译）
throw new AppException(LanguageEnum::PARAM_ERROR);

// 抛出异常（带参数替换）
throw new AppException(LanguageEnum::DB_EXECUTE_FAILED_WITH_MSG, $sql);
```

#### 错误码分类

| 分类 | 前缀 | 说明 |
|------|------|------|
| 参数错误 | `param.*` | 参数验证相关 |
| 数据库错误 | `db.*` | 数据库操作相关 |
| 文件错误 | `file.*` | 文件上传操作相关 |
| 路由错误 | `router.*` | 路由解析相关 |
| 后台管理 | `admin.*` | 后台管理相关 |
| 事件错误 | `event.*` | 事件系统相关 |
| 开发工具 | `dev.*` | 开发工具相关 |
| HTTP 错误 | `http.*` | HTTP 请求相关 |
| SSL 证书 | `ssl.*` | SSL 生成相关 |
| WebSocket | `ws.*` | WebSocket 相关 |
| 配置错误 | `config.*` | 配置相关 |
| 解析错误 | `parse.*` | 代码解析相关 |
| DTO 错误 | `dto.*` | DTO 操作相关 |
| 日志错误 | `log.*` | 日志相关 |
| 缓存错误 | `cache.*` | 缓存相关 |
| 表单错误 | `form.*` | 表单字段相关 |
| 功能支持 | `feature.*` | 功能不支持相关 |

#### 常用错误码

```php
// 参数验证
AppErr::PARAM_ERROR              // 参数错误
AppErr::PARAM_EMPTY              // 参数为空
AppErr::PARAM_REQUIRED           // 参数必填
AppErr::PARAM_INVALID            // 参数无效
AppErr::PARAM_MUST_STRING        // 参数必须是字符串
AppErr::PARAM_MUST_INT           // 参数必须是整数
AppErr::PARAM_MIN_LENGTH         // 参数最小长度错误
AppErr::PARAM_MAX_LENGTH         // 参数最大长度错误

// 数据库操作
AppErr::DB_EXECUTE_FAILED        // 数据库执行失败
AppErr::DB_WHERE_REQUIRED        // 数据库需要WHERE条件
AppErr::DB_CONNECT_ERROR         // 数据库连接错误

// 文件操作
AppErr::FILE_NOT_FOUND           // 文件不存在
AppErr::FILE_SAVE_FAILED         // 文件保存失败
AppErr::FILE_MIME_TYPE_REQUIRED  // MIME类型不能为空

// 后台管理
AppErr::ADMIN_PLEASE_LOGIN       // 请登录
AppErr::ADMIN_USERNAME_PASSWORD_ERROR  // 用户名或密码错误
AppErr::ADMIN_PERMISSION_DENIED   // 无权限

// HTTP
AppErr::HTTP_REQUEST_FAILED_WITH_MSG  // HTTP请求失败
```

### 19.3 翻译机制

异常消息通过 `Language::get()` 方法自动翻译：

```php
// 1. 错误码定义（带 I18nAttribute 注解）
#[I18nAttribute(zh: '参数错误', en: 'Parameter error')]
public const string PARAM_ERROR = 'param.error';

// 2. 抛出异常时自动翻译
throw new AppException(AppErr::PARAM_ERROR);
// 中文环境: "参数错误"
// 英文环境: "Parameter error"

// 3. 带参数的错误码
#[I18nAttribute(zh: 'SQL执行失败: %s', en: 'SQL execution failed: %s')]
public const string DB_EXECUTE_FAILED_WITH_MSG = 'db.execute_failed_with_msg';

throw new AppException(AppErr::DB_EXECUTE_FAILED_WITH_MSG, $sql);
// 输出: "SQL执行失败: SELECT * FROM users"
```

### 19.4 异常使用示例

```php
use Swlib\Controller\Language\Enum\LanguageEnum;use Swlib\Exception\AppException;use Swlib\Exception\TokenExpiredException;use Swlib\Exception\UnauthorizedException;

// 参数验证
if (empty($input)) {
    throw new AppException(LanguageEnum::PARAM_EMPTY);
}

// 数据库错误
if (!$result) {
    throw new AppException(LanguageEnum::DB_EXECUTE_FAILED_WITH_MSG, $sql);
}

// 用户未登录
if (!$user) {
    throw new UnauthorizedException(LanguageEnum::ADMIN_PLEASE_LOGIN);
}

// Token 过期（前端会自动刷新）
if ($tokenExpired) {
    throw new TokenExpiredException('token.expired');
}
```

### 19.5 最佳实践

1. **始终使用 AppErr 常量**：不要硬编码错误消息
   ```php
   // ✅ 正确
   throw new AppException(AppErr::PARAM_ERROR);

   // ❌ 错误
   throw new AppException('参数错误');
   ```

2. **选择合适的异常类型**：
   - 一般错误使用 `AppException`
   - 用户未登录使用 `UnauthorizedException`
   - Token 过期使用 `TokenExpiredException`
   - 需要重定向使用 `RedirectException`

3. **添加新的错误码**：在 `AppErr` 类中添加常量并配置翻译
   ```php
   #[I18nAttribute(zh: '订单不存在', en: 'Order not found')]
   public const string ORDER_NOT_FOUND = 'order.not_found';
   ```
