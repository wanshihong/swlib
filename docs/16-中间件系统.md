## 16. 中间件系统

### 16.1 创建中间件

```php
use Swlib\Router\RouterMiddleware;

class AuthMiddleware implements RouterMiddleware
{
    public function handle(): mixed
    {
        $token = Request::getHeader('authorization');

        if (empty($token)) {
            return JsonResponse::error('未授权访问', 401);
        }

        // 验证 token
        $user = $this->validateToken($token);
        if (!$user) {
            return JsonResponse::error('令牌无效', 401);
        }

        // 存储到上下文
        CtxEnum::CurrentUser->set($user);

        return true; // 继续执行
    }
}
```

### 16.2 应用中间件

```php
use Swlib\Router\Router;

// 在控制器上应用
#[Router(middleware: [AuthMiddleware::class])]
class ApiController extends AbstractController
{
    // 所有方法都需要认证
}

// 单个方法应用
#[Router(method: 'POST', middleware: [LogMiddleware::class])]
public function create(): JsonResponse
{
    // ...
}
```
